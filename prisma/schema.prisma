// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Business {
  id          String   @id @default(uuid())
  name        String
  industryId  String
  industry    Industry @relation(fields: [industryId], references: [id])
  themeConfig Json?    // Stores specific overrides like color choice
  settings    Json?    // General settings (tax, currency, etc.)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users       User[]
  features    BusinessFeature[]
  rules       BusinessRule[]
  items       Item[]
  categories  Category[]
  units       Unit[]
  taxes       Tax[]
  stocks      Stock[]
  movements   StockMovement[]
  warehouses  Warehouse[]
  sessions    PosSession[]
  sales       Sale[]
  accounts    Account[]
  journalEntries JournalEntry[]
  parties     Party[]
  auditLogs   AuditLog[]
  saleReturns SaleReturn[]
  stockAdjustments StockAdjustment[]
}

model Industry {
  id            String     @id @default(uuid())
  name          String     @unique
  iconPack      String     // e.g. "lucide-restaurant"
  defaultTheme  String?    // Reference to a theme preference
  defaultConfig Json?      // Default rules/features for this industry
  
  businesses    Business[]
}

model Theme {
  id           String @id @default(uuid())
  name         String @unique
  primaryColor String // hex or tailwind class
  mode         String // "light" | "dark"
}

model User {
  id         String     @id @default(uuid())
  email      String     @unique
  name       String?
  password   String
  status     String     @default("ACTIVE") // ACTIVE, INACTIVE, INVITED
  
  businessId String
  business   Business   @relation(fields: [businessId], references: [id])
  
  roleId     String
  role       Role       @relation(fields: [roleId], references: [id])
  
  warehouses UserWarehouse[]
  sessions   PosSession[]
  sales      Sale[]
  
  auditLogs  AuditLog[]
  saleReturns SaleReturn[]
  stockAdjustments StockAdjustment[]
  
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique // Admin, Manager, Cashier
  
  users       User[]
  permissions RolePermission[]
}

model Permission {
  id        String           @id @default(uuid())
  module    String           // e.g. "inventory", "pos"
  action    String           // e.g. "create", "read", "update", "delete"
  
  roles     RolePermission[]
  
  @@unique([module, action])
}

model RolePermission {
  id           String     @id @default(uuid())
  
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id])
  
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id])
  
  @@unique([roleId, permissionId])
}

model Feature {
  id          String            @id @default(uuid())
  key         String            @unique // e.g. "loyalty_program"
  description String?
  category    String?           // e.g. "POS", "INVENTORY"
  
  businesses  BusinessFeature[]
}

model BusinessRule {
  id            String   @id @default(uuid())
  
  businessId    String
  business      Business @relation(fields: [businessId], references: [id])
  
  ruleKey       String   // e.g. "discount.max_percent"
  ruleValue     Json
  scope         String   @default("GLOBAL") // POS, INVENTORY, etc.
  
  updatedAt     DateTime @updatedAt
  
  @@unique([businessId, ruleKey])
}

model BusinessFeature {
  id         String   @id @default(uuid())
  
  businessId String
  business   Business @relation(fields: [businessId], references: [id])
  
  featureId  String
  feature    Feature  @relation(fields: [featureId], references: [id])
  
  enabled    Boolean  @default(false)
  
  @@unique([businessId, featureId])
}

model Item {
  id                 String   @id @default(uuid())
  businessId         String
  business           Business @relation(fields: [businessId], references: [id])
  
  name               String
  code               String   // SKU / PLU
  type               String   // PRODUCT | SERVICE
  
  categoryId         String?
  category           Category? @relation(fields: [categoryId], references: [id])
  
  unitId             String?
  unit               Unit?     @relation(fields: [unitId], references: [id])
  
  basePrice          Decimal  @db.Decimal(18, 4)
  costPrice          Decimal  @db.Decimal(18, 4) @default(0)
  
  taxId              String?
  tax                Tax?      @relation(fields: [taxId], references: [id])
  
  trackStock         Boolean  @default(true)
  trackBatch         Boolean  @default(false)
  trackExpiry        Boolean  @default(false)
  allowNegativeStock Boolean? // Business-level override
  
  isActive           Boolean  @default(true)
  
  stocks             Stock[]
  movements          StockMovement[]
  saleItems          SaleItem[]
  saleReturnItems    SaleReturnItem[]
  stockAdjustments   StockAdjustment[]
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([businessId, code])
}

model Category {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id])
  name       String
  
  parentId   String?
  parent     Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children   Category[] @relation("CategoryToCategory")
  
  items      Item[]
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([businessId, name])
}

model Unit {
  id              String           @id @default(uuid())
  businessId      String
  business        Business         @relation(fields: [businessId], references: [id])
  name            String
  symbol          String
  
  items           Item[]
  fromConversions UnitConversion[] @relation("FromUnit")
  toConversions   UnitConversion[] @relation("ToUnit")

  @@unique([businessId, name])
}

model UnitConversion {
  id         String @id @default(uuid())
  fromUnitId String
  fromUnit   Unit   @relation("FromUnit", fields: [fromUnitId], references: [id])
  
  toUnitId   String
  toUnit     Unit   @relation("ToUnit", fields: [toUnitId], references: [id])
  
  multiplier Decimal @db.Decimal(18, 8)
}

model Tax {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id])
  name       String
  rate       Decimal  @db.Decimal(18, 4)
  type       String   // INCLUSIVE | EXCLUSIVE
  
  items      Item[]

  @@unique([businessId, name])
}

model Stock {
  id                String   @id @default(uuid())
  businessId        String
  business          Business @relation(fields: [businessId], references: [id])
  
  warehouseId       String
  warehouse         Warehouse @relation(fields: [warehouseId], references: [id])
  
  itemId            String
  item              Item     @relation(fields: [itemId], references: [id])
  
  quantityBaseUnit  Decimal  @db.Decimal(18, 4)
  
  batches           StockBatch[]
  
  updatedAt         DateTime @updatedAt

  @@unique([warehouseId, itemId])
}

model StockBatch {
  id                String   @id @default(uuid())
  stockId           String
  stock             Stock    @relation(fields: [stockId], references: [id])
  
  batchNo           String?
  expiryDate        DateTime?
  quantityBaseUnit  Decimal  @db.Decimal(18, 4)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model StockMovement {
  id                String   @id @default(uuid())
  businessId        String
  business          Business @relation(fields: [businessId], references: [id])
  
  itemId            String
  item              Item     @relation(fields: [itemId], references: [id])
  
  warehouseId       String
  warehouse         Warehouse @relation(fields: [warehouseId], references: [id])
  
  type              String   // IN | OUT | ADJUSTMENT | RETURN
  referenceType     String   // POS | PURCHASE | ADJUSTMENT
  referenceId       String?
  
  quantityBaseUnit  Decimal  @db.Decimal(18, 4)
  
  createdBy         String
  createdAt         DateTime @default(now())
}

model Warehouse {
  id          String   @id @default(uuid())
  businessId  String
  business    Business @relation(fields: [businessId], references: [id])
  name        String
  isDefault   Boolean  @default(false)
  
  stocks      Stock[]
  movements   StockMovement[]
  users       UserWarehouse[]
  sessions    PosSession[]
  sales       Sale[]
  stockAdjustments StockAdjustment[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([businessId, name])
}

model UserWarehouse {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([userId, warehouseId])
}

model PosSession {
  id          String   @id @default(uuid())
  businessId  String
  business    Business @relation(fields: [businessId], references: [id])
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  
  status      String   @default("OPEN") // OPEN | CLOSED | HOLD
  openedAt    DateTime @default(now())
  closedAt    DateTime?
  
  sales       Sale[]
}

model Sale {
  id              String   @id @default(uuid())
  invoiceNo       String   @unique
  businessId      String
  business        Business @relation(fields: [businessId], references: [id])
  
  sessionId       String?
  session         PosSession? @relation(fields: [sessionId], references: [id])
  
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  warehouseId     String
  warehouse       Warehouse @relation(fields: [warehouseId], references: [id])
  
  subtotal        Decimal  @db.Decimal(18, 4)
  taxTotal        Decimal  @db.Decimal(18, 4)
  discountTotal   Decimal  @db.Decimal(18, 4)
  total           Decimal  @db.Decimal(18, 4)
  
  status          String   @default("COMPLETED") // COMPLETED | CANCELLED | REFUNDED
  
  customerId      String?
  customer        Party?      @relation(fields: [customerId], references: [id])
  
  items           SaleItem[]
  payments        Payment[]
  returns         SaleReturn[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model SaleItem {
  id              String   @id @default(uuid())
  saleId          String
  sale            Sale     @relation(fields: [saleId], references: [id])
  
  itemId          String
  item            Item     @relation(fields: [itemId], references: [id])
  
  quantity        Decimal  @db.Decimal(18, 4)
  unitId          String
  
  unitPrice       Decimal  @db.Decimal(18, 4)
  taxAmount       Decimal  @db.Decimal(18, 4)
  discountAmount  Decimal  @db.Decimal(18, 4)
  total           Decimal  @db.Decimal(18, 4)
  
  batchNo         String?
}

model Payment {
  id              String   @id @default(uuid())
  saleId          String
  sale            Sale     @relation(fields: [saleId], references: [id])
  
  method          String   // CASH | CARD | BANK | CREDIT
  amount          Decimal  @db.Decimal(18, 4)
  referenceNo     String?
  
  createdAt       DateTime @default(now())
}

model Account {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id])
  name       String
  type       String   // ASSET | LIABILITY | INCOME | EXPENSE | EQUITY
  code       String?  // Optional account code
  
  journalLines JournalLine[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([businessId, name])
}

model JournalEntry {
  id            String   @id @default(uuid())
  businessId    String
  business      Business @relation(fields: [businessId], references: [id])
  date          DateTime @default(now())
  referenceType String?  // POS | RETURN | MANUAL
  referenceId   String?  // ID of the sale or other source
  description   String?
  
  lines         JournalLine[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model JournalLine {
  id             String       @id @default(uuid())
  journalEntryId String
  journalEntry   JournalEntry @relation(fields: [journalEntryId], references: [id])
  
  accountId      String
  account        Account      @relation(fields: [accountId], references: [id])
  
  debit          Decimal      @db.Decimal(18, 4) @default(0)
  credit         Decimal      @db.Decimal(18, 4) @default(0)
  
  partyLedger    PartyLedger?
}

model Party {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id])
  name       String
  type       String   // CUSTOMER | SUPPLIER
  email      String?
  phone      String?
  
  ledgers    PartyLedger[]
  sales      Sale[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([businessId, name, type])
}

model PartyLedger {
  id            String      @id @default(uuid())
  partyId       String
  party         Party       @relation(fields: [partyId], references: [id])
  
  journalLineId String      @unique
  journalLine   JournalLine @relation(fields: [journalLineId], references: [id])
  
  createdAt     DateTime    @default(now())
}

model AuditLog {
  id         String   @id @default(uuid())
  
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  
  businessId String
  business   Business @relation(fields: [businessId], references: [id])
  
  module     String
  action     String
  before     Json?
  after      Json?
  
  timestamp  DateTime @default(now())
}

model SaleReturn {
  id              String   @id @default(uuid())
  businessId      String
  business        Business @relation(fields: [businessId], references: [id])
  
  saleId          String
  sale            Sale     @relation(fields: [saleId], references: [id])
  
  reason          String?
  
  status          String   @default("COMPLETED") // COMPLETED | CANCELLED
  
  subtotal        Decimal  @db.Decimal(18, 4)
  taxTotal        Decimal  @db.Decimal(18, 4)
  total           Decimal  @db.Decimal(18, 4)
  
  createdBy       String
  user            User     @relation(fields: [createdBy], references: [id])
  
  items           SaleReturnItem[]
  refunds         Refund[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model SaleReturnItem {
  id              String   @id @default(uuid())
  saleReturnId    String
  saleReturn      SaleReturn @relation(fields: [saleReturnId], references: [id])
  
  itemId          String
  item            Item     @relation(fields: [itemId], references: [id])
  
  quantity        Decimal  @db.Decimal(18, 4)
  unitPrice       Decimal  @db.Decimal(18, 4)
  taxAmount       Decimal  @db.Decimal(18, 4)
  total           Decimal  @db.Decimal(18, 4)
}

model Refund {
  id              String   @id @default(uuid())
  saleReturnId    String
  saleReturn      SaleReturn @relation(fields: [saleReturnId], references: [id])
  
  method          String   // CASH | CARD | BANK | CREDIT
  amount          Decimal  @db.Decimal(18, 4)
  
  createdAt       DateTime @default(now())
}

model StockAdjustment {
  id              String   @id @default(uuid())
  businessId      String
  business        Business @relation(fields: [businessId], references: [id])
  
  itemId          String
  item            Item     @relation(fields: [itemId], references: [id])
  
  warehouseId     String
  warehouse       Warehouse @relation(fields: [warehouseId], references: [id])
  
  quantityBaseUnit Decimal  @db.Decimal(18, 4)
  reason          String?
  type            String   // IN | OUT
  
  createdBy       String
  user            User     @relation(fields: [createdBy], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
